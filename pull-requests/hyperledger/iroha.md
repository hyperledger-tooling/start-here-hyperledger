---
layout: default
title: iroha
parent: Hyperledger
grand_parent: Pull Requests
has_children: false
permalink: /pull-requests/hyperledger/iroha
---

# iroha <span class="fs-3 right-align">[GitHub](https://github.com/hyperledger/iroha){: .btn .mr-4 }</span>


<div>
    <table>
        <tr>
            <td>
                PR <a href="https://github.com/hyperledger/iroha/pull/4115" class=".btn">#4115</a>
            </td>
            <td>
                <b>
                    [fix] #3657: Split view changes from normal messages
                </b>
            </td>
        </tr>
        <tr>
            <td>
                <span class="chip">iroha2</span>
            </td>
            <td>
                ## Description

<!-- Just describe what you did. -->

<!-- Skip if the title of the PR is self-explanatory -->

### Linked issue

<!-- Duplicate the main issue and add additional issues closed by this PR. -->

Closes #{issue_number} <!-- Replace with an actual number,  -->

<!-- Link if e.g. JIRA issue or  from another repository -->

### Benefits

<!-- EXAMPLE: users can't revoke their own right to revoke rights -->

### Checklist

- [ ] I've read `CONTRIBUTING.md`
- [ ] I've used the standard signed-off commit format (or will squash just before merging)
- [ ] All applicable CI checks pass (or I promised to make them pass later)
- [ ] (optional) I've written unit tests for the code changes
- [ ] I replied to all comments after code review, marking all implemented changes with thumbs up

<!-- HINT:  Add more points to checklist for large draft PRs-->

<!-- USEFUL LINKS 
 - https://www.secondstate.io/articles/dco
 - https://discord.gg/hyperledger (please ask us any questions)
 - https://t.me/hyperledgeriroha (if you prefer telegram)
-->

            </td>
        </tr>
    </table>
    <div class="right-align">
        Created At 2023-12-05 00:29:04 +0000 UTC
    </div>
</div>

<div>
    <table>
        <tr>
            <td>
                PR <a href="https://github.com/hyperledger/iroha/pull/4114" class=".btn">#4114</a>
            </td>
            <td>
                <b>
                    [fix] #4099: Fix of the websocket request builder
                </b>
            </td>
        </tr>
        <tr>
            <td>
                <span class="chip">iroha2</span>
            </td>
            <td>
                ## Description

Fixed the web socket bug which gives HTTP 400.
All library versions saved as-is

### Linked issue

<!-- Duplicate the main issue and add additional issues closed by this PR. -->

- Closes #4099: <!-- Replace with an actual number,  -->

<!-- Link if e.g. JIRA issue or  from another repository -->

### Benefits

<!-- EXAMPLE: users can't revoke their own right to revoke rights -->

### Checklist

- [x] I've read `CONTRIBUTING.md`
- [x] I've used the standard signed-off commit format (or will squash just before merging)
- [x] All applicable CI checks pass (or I promised to make them pass later)
- [x] (optional) I've written unit tests for the code changes
- [x] I replied to all comments after code review, marking all implemented changes with thumbs up

<!-- HINT:  Add more points to checklist for large draft PRs-->

<!-- USEFUL LINKS 
 - https://www.secondstate.io/articles/dco
 - https://discord.gg/hyperledger (please ask us any questions)
 - https://t.me/hyperledgeriroha (if you prefer telegram)
-->

            </td>
        </tr>
    </table>
    <div class="right-align">
        Created At 2023-12-04 12:50:44 +0000 UTC
    </div>
</div>

<div>
    <table>
        <tr>
            <td>
                PR <a href="https://github.com/hyperledger/iroha/pull/4113" class=".btn">#4113</a>
            </td>
            <td>
                <b>
                    [BACKPORT] #4099: Fix of the websocket request builder
                </b>
            </td>
        </tr>
        <tr>
            <td>
                <span class="chip">iroha2</span>
            </td>
            <td>
                ## Description

Fixed the web socket bug which gives HTTP 400.
All library versions saved as-is

### Linked issue

<!-- Duplicate the main issue and add additional issues closed by this PR. -->

- Closes #4099  <!-- Replace with an actual number,  -->

<!-- Link if e.g. JIRA issue or  from another repository -->

### Benefits

<!-- EXAMPLE: users can't revoke their own right to revoke rights -->

### Checklist

- [x] I've read `CONTRIBUTING.md`
- [x] I've used the standard signed-off commit format (or will squash just before merging)
- [x] All applicable CI checks pass (or I promised to make them pass later)
- [x] (optional) I've written unit tests for the code changes
- [x] I replied to all comments after code review, marking all implemented changes with thumbs up

<!-- HINT:  Add more points to checklist for large draft PRs-->

<!-- USEFUL LINKS 
 - https://www.secondstate.io/articles/dco
 - https://discord.gg/hyperledger (please ask us any questions)
 - https://t.me/hyperledgeriroha (if you prefer telegram)
-->

            </td>
        </tr>
    </table>
    <div class="right-align">
        Created At 2023-12-04 11:08:32 +0000 UTC
    </div>
</div>

<div>
    <table>
        <tr>
            <td>
                PR <a href="https://github.com/hyperledger/iroha/pull/4108" class=".btn">#4108</a>
            </td>
            <td>
                <b>
                    [BACKPORT]: replace test_env.sh with test_env.py in CI
                </b>
            </td>
        </tr>
        <tr>
            <td>
                <span class="chip">iroha2</span>
            </td>
            <td>
                ## Description

<!-- Just describe what you did. -->

<!-- Skip if the title of the PR is self-explanatory -->

### Linked issue

<!-- Duplicate the main issue and add additional issues closed by this PR. -->

Closes #{issue_number} <!-- Replace with an actual number,  -->

<!-- Link if e.g. JIRA issue or  from another repository -->

### Benefits

<!-- EXAMPLE: users can't revoke their own right to revoke rights -->

### Checklist

- [ ] I've read `CONTRIBUTING.md`
- [ ] I've used the standard signed-off commit format (or will squash just before merging)
- [ ] All applicable CI checks pass (or I promised to make them pass later)
- [ ] (optional) I've written unit tests for the code changes
- [ ] I replied to all comments after code review, marking all implemented changes with thumbs up

<!-- HINT:  Add more points to checklist for large draft PRs-->

<!-- USEFUL LINKS 
 - https://www.secondstate.io/articles/dco
 - https://discord.gg/hyperledger (please ask us any questions)
 - https://t.me/hyperledgeriroha (if you prefer telegram)
-->

            </td>
        </tr>
    </table>
    <div class="right-align">
        Created At 2023-11-30 08:29:34 +0000 UTC
    </div>
</div>

<div>
    <table>
        <tr>
            <td>
                PR <a href="https://github.com/hyperledger/iroha/pull/4107" class=".btn">#4107</a>
            </td>
            <td>
                <b>
                    [fix] #4106: Fix trigger atomicity
                </b>
            </td>
        </tr>
        <tr>
            <td>
                <span class="chip">Bug</span><span class="chip">iroha2</span>
            </td>
            <td>
                ## Description

Fix trigger atomicity by cloning wsv.

<!-- Just describe what you did. -->

<!-- Skip if the title of the PR is self-explanatory -->

### Linked issue

<!-- Duplicate the main issue and add additional issues closed by this PR. -->

Closes #4106<!-- Replace with an actual number,  -->

<!-- Link if e.g. JIRA issue or  from another repository -->

<!-- USEFUL LINKS 
 - https://www.secondstate.io/articles/dco
 - https://discord.gg/hyperledger (please ask us any questions)
 - https://t.me/hyperledgeriroha (if you prefer telegram)
-->

            </td>
        </tr>
    </table>
    <div class="right-align">
        Created At 2023-11-30 07:48:05 +0000 UTC
    </div>
</div>

<div>
    <table>
        <tr>
            <td>
                PR <a href="https://github.com/hyperledger/iroha/pull/4103" class=".btn">#4103</a>
            </td>
            <td>
                <b>
                    [chore]: #4102 Update issue templates
                </b>
            </td>
        </tr>
        <tr>
            <td>
                
            </td>
            <td>
                This PR changes the issue templates for Iroha.
            </td>
        </tr>
    </table>
    <div class="right-align">
        Created At 2023-11-30 06:44:09 +0000 UTC
    </div>
</div>

<div>
    <table>
        <tr>
            <td>
                PR <a href="https://github.com/hyperledger/iroha/pull/4100" class=".btn">#4100</a>
            </td>
            <td>
                <b>
                    [fix] #4030, #4063, #4064, #4079: re-architect logger and dynamic configuration
                </b>
            </td>
        </tr>
        <tr>
            <td>
                <span class="chip">Enhancement</span><span class="chip">iroha2</span><span class="chip">api-changes</span><span class="chip">config-changes</span><span class="chip">Refactor</span>
            </td>
            <td>
                ## Description

Started by updating configuration endpoints according to #4063, this PR expanded to major update of dynamic configuration mechanism, Logger configuration (#4030, #4064) and initialisation.

Logger initialisation is a global one-time thing, which was done with `iroha_logger::init(Configuration)`  function, which might accept the config and initialise logger, or might not, without an error. While initialising, it injected a `ReloadHandle` into the configuration instance, so that all updates to `config.logger.max_log_level` would trigger updates set up within `iroha_logger::init`. Than that `config` was copied many times in `Torii` and log level was actually reloaded on `POST /configuration` updates.

However, the configuration value update was not reflected in subsequent `GET /configuration` requests (#4079), because each time `config` is copied (it was copied for each request), it was editing a copy of `config` without affecting an original one. Since a copy of `config` was still containing `ReloadHandle` from Logger, the log level was updated.

Another problem appeared because of combination of configuration & logger architecture, in tests. It appeared that some tests ran concurrently, each calling `iroha_logger::init` with  independent `Configuration`s. However, only one `iroha_logger::init` might succeed, and another silently pretends that everything is ok. It worked fine, until one of Iroha instances fails to update the log level, because its `Configuration` passed into `iroha_logger::init` was not injected with a `ReloadHandle`.

Shortly, the system was *unsound*, i.e. it was easy to misuse. 

**Changes in this PR:**

- Remove `ReloadHandle` and `SyncValue` from configuration
- Introduce Kiso (jp 基礎 - foundation; basis): an actor responsible for holding the configuration state and broadcasting its updates across the system in a fire-and-forget way
- Update Logger configuration according to #4030 and #4064
- Introduce Logger actor, which might be initialised only once per process, and which is responsible for log level reloading and telemetry subscriptions
- Update Logger initialisation: split `init(Configuration) -> Result<Option<Telemetries>>` into
    - `init_global(Configuration) -> Result<LoggerHandle>`, initialising the Logger actor once per process, and failing if it was done already
    - `test_logger() -> LoggerHandle`, lazily initialising the Logger actor with pre-defined configuration, suitable for tests

**Chores:**

- Remove redundant fields from Kura configuration
- Refactor telemetry broadcasting mechanisms

### Linked issue

Closes #4030 #4063 #4064 #4079

### Benefits

- Improves configuration UX
- Improves system soundness

### Checklist

- [x] Refactor Kiso in a fire-and-forget manner
- [x] Play with logger manually
  - [x] Check if `bunyan` can parse current JSON output
- [x] Update logger config in py test env
- [x] Update README logger documentation
- [x] Use `202 Accepted` for `POST /configuration`

### Migration guide

#### Update Logger configuration

**In the configuration file, under `LOGGER.*` namespace:**

- Rename `MAX_LOG_LEVEL` to `LEVEL`
- Remove `COMPACT_MODE`; use `FORMAT: "full"` (if `false`) and `FORMAT: "compact"` (if `true`) instead
- Remove `LOG_FILE_PATH`; use `FORMAT: "json"` instead and redirect stdout to a file, e.g. `iroha > log.json`
- Remove `TERMINAL_COLORS`; use `--terminal-colors`/`--no-terminal-colors` CLI arguments instead
- Remove `TELEMETRY_CAPACITY`

**Env variables:**

- `LOG_LEVEL`: instead of `MAX_LOG_LEVEL`
- `LOG_FORMAT`: new parameter
- `LOG_TOKIO_CONSOLE_ADDR`: instead of `TOKIO_CONSOLE_ADDR`

**Example file before:**

```json
{
  "LOGGER": {
    "MAX_LOG_LEVEL": "INFO",
    "TELEMETRY_CAPACITY": 1000,
    "COMPACT_MODE": false,
    "LOG_FILE_PATH": null,
    "TERMINAL_COLORS": true
  }
}
```

**Example file after:**

```json
{
  "LOGGER": {
    "LEVEL": "INFO",
    "FORMAT": "full"
  }
}
```

#### Update configuration endpoints usage

- `GET /configuration` now returns JSON with only `{ logger: { level } }`.
- `POST /configuration` now accepts JSON in the same shape

**`POST /configuration` request before:**

```json
{"LogLevel":"DEBUG"}
```

**`POST /configuration` request after:**

```json
{"logger":{"level":"DEBUG"}}
```

            </td>
        </tr>
    </table>
    <div class="right-align">
        Created At 2023-11-30 04:55:26 +0000 UTC
    </div>
</div>

